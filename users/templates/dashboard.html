{% extends 'base_user.html' %}
{% load static %}
{% block title %}
  Dashboard de {{ user.get_primeiro_nome }}
{% endblock %}

{% block content %}
  <div class="card mb-3">
    <div class="card-header d-flex">
      <h3 class="card-title fw-bold my-auto">Suas redes sociais</h3>
      <a class="btn btn-success ms-auto" href="{% url 'user_social_link_create' %}">Cadastrar</a>
    </div>
    <div class="card-body table-responsive p-0">
      <table class="table table-hover text-nowrap">
        <thead>
          <tr>
            <th>Rede social</th>
            <th>URL</th>
            <th>Opções</th>
          </tr>
        </thead>
        <tbody>
          {% for s in user.social_links.all %}
            <tr>
              <td>{{ s.rede.nome }}</td>
              <td>
                <a href="{{ s.rede.url_base }}/{{ s.url }}">{{ s.rede.url_base }}/{{ s.url }}</a>
              </td>

              <td class="d-flex gap-2">
                <a href="{% url 'user_social_link_update' s.id %}" class="btn btn-sm btn-warning">Editar</a>
                <a class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmarExclusaoSocialLinkModal{{ s.pk }}">Excluir</a>
              </td>
            </tr>
            {% include 'partials/_modal_delete_social_link.html' %}
          {% empty %}
            <tr>
              <td colspan="4">Você ainda não cadastrou redes socias.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex">
      <h3 class="card-title fw-bold my-auto">Seus projetos</h3>
      {% if perms.repex.add_projeto %}
        <a class="btn btn-success ms-auto" href="{% url 'projeto_create' %}">Cadastrar</a>
      {% endif %}
    </div>
    <div class="card-body table-responsive p-0">
      <table class="table table-hover text-nowrap">
        <thead>
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Status</th>
            <th>Modalidade</th>
            <th>Visualizações</th>
            <th>Opções</th>
          </tr>
        </thead>
        <tbody id="ajax_projetos">
          {% include "partials/_dashboard_ajax_projetos.html" %}
        </tbody>
      </table>
    </div>
    <div id="ajax_pagination">
      {% include "partials/_dashboard_pagination_projetos.html" %}
    </div>
  </div>

  {% if perms.repex.add_noticia %}
    <div class="card">
      <div class="card-header d-flex">
        <h3 class="card-title fw-bold my-auto">Suas notícias</h3>
        <a class="btn btn-success ms-auto" href="{% url 'noticia_create' %}">Cadastrar</a>
      </div>
      <div class="card-body table-responsive p-0">
        <table class="table table-hover text-nowrap">
          <thead>
            <tr>
              <th>ID</th>
              <th>Título</th>
              <th>Área de conhecimento</th>
              <th>Criado em</th>
              <th>Opções</th>
            </tr>
          </thead>
          <tbody>
            {% for n in user.noticias.all %}
              <tr>
                <td>{{ n.id }}</td>
                <td>{{ n.titulo }}</td>
                <td>{{ n.area_conhecimento }}</td>
                <td>{{ n.criado_em }}</td>
                <td class="d-flex gap-2">
                  <a href="{% url 'noticia_detail' n.id %}" class="btn btn-sm btn-primary">Ver</a>
                  {% if perms.repex.change_noticia %}
                    <a href="{% url 'noticia_update' n.id %}" class="btn btn-sm btn-warning">Editar</a>
                  {% endif %}
                  {% if perms.repex.delete_noticia %}
                    <a class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmarExclusaoNoticiaModal{{ n.pk }}">Excluir</a>
                  {% endif %}
                </td>
              </tr>
              {% if perms.repex.delete_noticia %}
                {% include 'partials/_modal_delete_noticia.html' %}
              {% endif %}
            {% empty %}
              <tr>
                <td colspan="4">Você ainda não criou nenhuma notícia.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
{% endblock %}
{% block extra_scripts %}
<script>
  $(document).on('click', '#ajax_pagination .pagination a', function (e) {
  e.preventDefault();

  let page = $(this).attr('href').split('page=')[1] || 1;

  $.ajax({
    url: "{% url 'dashboard_ajax_projetos' %}",
    type: 'GET',
    data: { page: page },
    beforeSend: function () {
      $('#spinner').show();
    },
    success: function (data) {
      $('#ajax_projetos').html(data.html_tabela);
      $('#ajax_pagination').html(data.html_paginacao);
    },
    complete: function () {
      $('#spinner').hide();
    },
    error: function (xhr, status, error) {
      console.error('Erro ao carregar página:', error);
    }
  });
});
</script>
{% endblock extra_scripts %}